<!DOCTYPE html>

<html>

  <head>
    <meta charset="utf-8">
    <meta name = "viewport" content = "width=device-widht,initial-scale=1.0">
    <title>Perfil Sócio Econômico</title>
    <link rel="stylesheet" type="text/css" href="_style/estilo.css">
  <body bgcolor="d3d3d3">
    <script src="_bibliotecagrafico/code/highcharts.js"></script>
    <script src="_bibliotecagrafico/code/highcharts-3d.js"></script>
    <script src="_bibliotecagrafico/code/modules/exporting.js"></script>
    <div class="barra">
	    <nav class = "menu">
	      <ul>  
	        <li><a href = "#">F A C U L D A D E D E T E C N O L O G I A</a></li>  
	      </ul>       
	    </nav>
	    <div class="quadfatec">
	        <img src="_images/site-header3.png" >
	    </div>
	    <nav class="main-nav">       
	      <ul class="main-nav-ul">                              
	        <li><a href="#" onclick="Home()">Home</a></li>     
	        <li><a href="#" onclick="ApareceBtn()">Importar Arquivo CSV</a></li>
	      </ul> 
	    </nav>  
	    <p><label for="inputCSV" id="btnCSV">Importar<input type="file" name="coletaCSV" id="inputCSV" onchange="pegaCSV(this)" accept=".CSV" /></label></p>
	    <div id="selecionaGrafico">
	      <p>
	        <label for="Pizza"><input type="radio" name="tipoGrafico" id="Pizza" value="Pizza" onchange="graphic()" checked>Pizza</label>
	        <label for="Coluna"><input type="radio" name="tipoGrafico" id="Coluna" value="Coluna" onchange="graphic()">Coluna</label>
	      </p>
	    </div>
	    <div id="select-estiloso">
	    	<select id="colunaescolhida" name="escolheColuna" onchange="teste()">
				<option value="4">Período de estudo</option>
				<option value="6">Idade</option>
				<option value="7">Estado Civil</option>
				<option value="8">Possui Deficiencia</option>
				<option value="10">Tem Filhos</option>
				<option value="14">Município</option>
				<option value="21">Locomoção</option>
				<option value="22">Situação da Moradia</option>
				<option value="24">Com quem mora</option>
				<option value="25">Quantidade na Família</option>
				<option value="26">Quantos Trabalham</option>
				<option value="27">Quantidade de Salário Minímo</option>
				<option value="28">Trabalho</option>
				<option value="30">Vida escolar</option>
				<option value="31">Tem conhecimento em Informática</option>
				<option value="33">Fala outro idioma</option>
			</select>
		</div>
	    <div id="container" ></div>
	    <div id="PInicial">
		    <p id="BoasVindas">Seja bem-vindo ao nosso site</p>
		    <p id="Info">Para começar clique em IMPORTAR ARQUIVO CSV</p>
		</div>
	</div>

    <script type="text/javascript">
      var colunaescolhida = parseInt(document.getElementById('colunaescolhida').value);
      var nomeSerie = document.getElementById('colunaescolhida').options[document.getElementById('colunaescolhida').selectedIndex].text;
      var fileArr;
      var leitorDeCSV = new FileReader();
      var fileColumn = [];
      var valores = [];
      var dados = [];

      function Home(){
      	document.getElementById('btnCSV').style.display = "none";
      	document.getElementById('container').style.display = 'block';
      	document.getElementById('selecionaGrafico').style.display = "block";
      	document.getElementById('select-estiloso').style.display = "block";
      }

      function ApareceBtn(){
      	document.getElementById('btnCSV').style.display = 'block';
      	document.getElementById('container').style.display = 'none';
      	document.getElementById('selecionaGrafico').style.display = "none";
      	document.getElementById('select-estiloso').style.display = "none";
      	document.getElementById('PInicial').style.display = "none";

      }    

      window.onload = function init(){
        leitorDeCSV.onload = leCSV
      }

      function pegaCSV(inputFile) {
        var file = inputFile.files[0];
        leitorDeCSV.readAsText(file);
      }

      function leCSV(evt){
        fileArr = evt.target.result.split('\n');
        fileArr.toString();
        teste();
        document.getElementById('btnCSV').style.display = "none";
        document.getElementById('selecionaGrafico').style.display = "block";
        document.getElementById('container').style.display = "block";
        document.getElementById('select-estiloso').style.display = "block";
      }   

      function teste(){ 
        //Reinicia as variáveis
        colunaescolhida = parseInt(document.getElementById('colunaescolhida').value);
        dados = [];
        valores = [];
        data = [];
        lista_ra = [];
        //Corrige as colunas
        var indice = 0
        if (colunaescolhida > 12){
          d = colunaescolhida + 1;
        }
        else{
          d = colunaescolhida;
        }

        // inicia leitura dos dados
        for (var i = 1; i<fileArr.length-1; i++){
          var fileLine = fileArr[i].split(',');
          ra = fileLine[5];
          if(lista_ra.indexOf(ra) == -1){
            lista_ra.push(ra);
            var y = fileLine[d];
            
            //tira aspas
            if(y != null && y != "" && y != undefined){
              var x = y.replace(/"/g, '');
            }
            //Gera array dos cabeçalhos 
            if(d==6 && dados.length==0){
              dados.push('Até 20 anos ','De 21 a 30 anos ','De 31 a 40 anos ','Mais de 40 anos ');
            }
            else if(d==26 && dados.length==0){
              dados.push('Um ','Dois ','Três ','Quatro ','Cinco ','Seis ','Mais que seis ');
            }
            else if(d==27 && dados.length==0){
              dados.push('Ninguém ','Um ','Dois ','Três ', 'Quatro ','Cinco ','Mais que cinco ');
            }
            else if(d==28 && dados.length==0){
              dados.push('Um ','Dois ','Três ', 'Quatro ','Cinco ','Mais que cinco ');
            }
            else{
              if(dados.indexOf(x) == -1){
                dados.push(x);
              }
            }   

            //gera array de valores
            if(d==6){
              
              var age = x.split('/');
              var hoje = new Date();
              for(var j = 0; j < age.length; j++){
                if (j == 0){
                  var aux = age[j];
                  age[j] = age[j + 1];
                  age[j + 1] = aux;
                }
              }
              var nasc = new Date(age);
              var timeDiff = Math.abs(hoje.getTime() - nasc.getTime());
              var diffAge = Math.ceil(timeDiff / (1000 * 3600 * 24 * 365.25)); 

              if(diffAge<21){
                indice = 0;
              }
              else if(diffAge>=21 && diffAge<31){
                indice = 1;
              }
              else if(diffAge>=31 && diffAge<41){
                indice = 2;
              }
              else{
                indice = 3;
              }
            }
            else if(d==26){
              if(x=='1')
                indice = 0;
              else if(x=='2')
                indice = 1;
              else if(x=='3')
                indice = 2;
              else if(x=='4')
                indice = 3;
              else if(x=='5')
                indice = 4;
              else if(x=='6')
                indice = 5;
              else
                indice = 6;
            }
            else if(d==27){
              if(x=='NINGUEM')
                indice = 0;
              else if(x=='1')
                indice = 1;
              else if(x=='2')
                indice = 2;
              else if(x=='3')
                indice = 3;
              else if(x=='4')
                indice = 4;
              else if(x=='5')
                indice = 5;
              else 
                indice = 6;
            }
            else if(d==28){
              if(x=='1')
                indice = 0;
              else if(x=='2')
                indice = 1;
              else if(x=='3')
                indice = 2;
              else if(x=='4')
                indice = 3;
              else if(x=='5')
                indice = 4;
              else 
                indice = 5;
            }
            else{ 
              indice = dados.indexOf(x);
            }
            if (valores[indice] == null) {
                valores[indice] = 0;
              }
            valores[indice]++;
          }
        }

        //gera array no formato data:value para printar no grafico
        for(var i = 0; i<valores.length;i++){
          data.push({
            name: dados[i],
            y: valores[i]
          });
        }
        graphic();
      } 
      


      function graphic(){
        var escolhaGrafico = document.querySelectorAll('input[type=radio]:checked')[0].value;
        nomeSerie = document.getElementById('colunaescolhida').options[document.getElementById('colunaescolhida').selectedIndex].text;
        if (escolhaGrafico == "Pizza") {
          Highcharts.chart('container', {
              chart: {
                  type: 'pie',
                  options3d: {
                      enabled: true,
                      alpha: 45,
                      beta: 0
                  }
              },
              title: {
                  text: nomeSerie,            },
              tooltip: {
                  pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
              },
              plotOptions: {
                  pie: {
                      allowPointSelect: true,
                      cursor: 'pointer',
                      depth: 35,
                      dataLabels: {
                          enabled: true,
                          format: '{point.name}:{point.y}',
                      }
                  }
              },
              series: [{
                  type: 'pie',
                  name: 'Porcentagem',
                  data:  data
              }]
          });   

        }
        else if (escolhaGrafico == 'Coluna'){
          Highcharts.chart('container', {
              chart: {
                  type: 'column',
                  options3d: {
                      enabled: true,
                      alpha: 10,
                      beta: 25,
                      depth: 70
                  }
              },
              title: {
                  text: "",
              },
              subtitle: {
                  text: ''
              },
              plotOptions: {
                  column: {
                      depth: 25
                  }
              },
              xAxis: {
                  categories: dados,
                  labels: {
                      skew3d: true,
                      style: {
                          fontSize: '16px'
                      }
                  }
              },
              yAxis: {
                  title: {
                      text: null
                  }
              },
              series: [{
                  name: [nomeSerie],
                  data: valores
              }]
          });
        }
      };

    </script> 
  </body>
</html>
<!DOCTYPE html>

<html>

  <head>
    <meta charset="utf-8">
    <meta name = "viewport" content = "width=device-widht,initial-scale=1.0">
    <title>TRABALHO ENROLAND</title>
    <link rel="stylesheet" type="text/css" href="_style/estilo.css">
  <body bgcolor="d3d3d3">
    <script src="_bibliotecagrafico/code/highcharts.js"></script>
    <script src="_bibliotecagrafico/code/highcharts-3d.js"></script>
    <script src="_bibliotecagrafico/code/modules/exporting.js"></script>
    <div class="barra">
    <nav class = "menu">
      <ul>  
        <li><a href = "#">F A C U L D A D E D E T E C N O L O G I A</a></li>  
      </ul>       
    </nav>
    <div class="quadfatec">
        <img src="_images/site-header3.png" >
      </div>
    <nav class="main-nav">       
      <ul class="main-nav-ul">                              
        <li><a href="#">Home</a></li>
        <li><a href="#">Produtos<span class="sub-arrow"></span></a> 
          <ul id="coluna">
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="4" href="#">Período</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="6" href="#">Idade</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="7" href="#">Estado Civil</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="8" href="#">Possui Deficiencia</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="10" href="#">Tem Filhos</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="14" href="#">Munícipio</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="21" href="#">Locomoção</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="22" href="#">Situação da Moradia</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="24" href="#">Com quem mora</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="25" href="#">Quantidade de pessoas na Família</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="26" href="#">Quantos Trabalham</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="27" href="#">Quantidade de Salários Mínimos</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="28" href="#">Trabalho</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="30" href="#">Vida Escolar</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="31" href="#">Tem Conhecimento em informáticac</a></li>
            <li ><a onclick="pegaInfo(this.id, this.firstChild.nodeValue)" id="33" href="#">Fala outro idioma</a></li>      
          </ul>
        </li>     
        <li><a href="#">Serviços</a></li>
        <li><a href="#">Sobre</a></li>
        <li><a href="#">Contato</a></li>
      </ul> 
    </nav>  
    <form id="formulario">
      <p><label for="coletaCSV">Insira seu arquivo CSV<input type="file" name="coletaCSV" id="inputCSV" onchange="pegaCSV(this)" accept=".CSV" /></label></p>
    </form>
    <div id="selecionaGrafico">
      <p>
        <label for="Pizza"><input type="radio" name="tipoGrafico" value="Pizza" onchange="graphic()" checked>Pizza</label>
        <label for="Coluna"><input type="radio" name="tipoGrafico" value="Coluna" onchange="graphic()">Coluna</label>
      </p>
    </div>
    <div id="container" ></div>
</div>

    <script type="text/javascript">
      var colunaescolhida = 4;
      var nomeSerie = "Período";
      var fileArr;
      var leitorDeCSV = new FileReader();
      var fileColumn = [];
      var valores = [];
      var dados = [];

      function pegaInfo(id, conteudo){  
        colunaescolhida = parseInt(id);
        nomeSerie = conteudo;
        teste();
      }      

      window.onload = function init(){
        leitorDeCSV.onload = leCSV
      }

      function pegaCSV(inputFile) {
        var file = inputFile.files[0];
        leitorDeCSV.readAsText(file);
      }

      function leCSV(evt){
        fileArr = evt.target.result.split('\n');
        fileArr.toString();
        teste();
        document.getElementById('formulario').style.display = "none";
        document.getElementById('selecionaGrafico').style.display = "block";
      }   

      function teste(){ 
        dados = [];
        valores = [];
        data = [];
        lista_ra = [];
        var indice = 0
        if (colunaescolhida > 12){
          d = colunaescolhida + 1;
        }
        else{
          d = colunaescolhida;
        }

        // inicia leitura dos dados
        for (var i = 1; i<fileArr.length-1; i++){
          var fileLine = fileArr[i].split(',');
          ra = fileLine[5];
          if(lista_ra.indexOf(ra) == -1){
            lista_ra.push(ra);
            var y = fileLine[d];
            
            //tira aspas
            if(y != null && y != "" && y != undefined){
              var x = y.replace(/"/g, '');
            }
            //Gera array dos cabeçalhos 
            if(d==6 && dados.length==0){
              dados.push('Até 20 anos ','De 21 a 30 anos ','De 31 a 40 anos ','Mais de 40 anos ');
            }
            else if(d==26 && dados.length==0){
              dados.push('Um ','Dois ','Três ','Quatro ','Cinco ','Seis ','Mais que seis ');
            }
            else if(d==27 && dados.length==0){
              dados.push('Ninguém ','Um ','Dois ','Três ', 'Quatro ','Cinco ','Mais que cinco ');
            }
            else if(d==28 && dados.length==0){
              dados.push('Um ','Dois ','Três ', 'Quatro ','Cinco ','Mais que cinco ');
            }
            else{
              if(dados.indexOf(x) == -1){
                dados.push(x);
              }
            }   

            //gera array de valores
            if(d==6){
              
              var age = x.split('/');
              var hoje = new Date();
              for(var j = 0; j < age.length; j++){
                if (j == 0){
                  var aux = age[j];
                  age[j] = age[j + 1];
                  age[j + 1] = aux;
                }
              }
              var nasc = new Date(age);
              var timeDiff = Math.abs(hoje.getTime() - nasc.getTime());
              var diffAge = Math.ceil(timeDiff / (1000 * 3600 * 24 * 365)); 

              if(diffAge<21){
                indice = 0;
              }
              else if(diffAge>=21 && diffAge<31){
                indice = 1;
              }
              else if(diffAge>=31 && diffAge<41){
                indice = 2;
              }
              else{
                indice = 3;
              }
            }
            else if(d==26){
              if(x=='1')
                indice = 0;
              else if(x=='2')
                indice = 1;
              else if(x=='3')
                indice = 2;
              else if(x=='4')
                indice = 3;
              else if(x=='5')
                indice = 4;
              else if(x=='6')
                indice = 5;
              else
                indice = 6;
              console.log(indice + ": " +ra)
            }
            else if(d==27){
              if(x=='NINGUEM')
                indice = 0;
              else if(x=='1')
                indice = 1;
              else if(x=='2')
                indice = 2;
              else if(x=='3')
                indice = 3;
              else if(x=='4')
                indice = 4;
              else if(x=='5')
                indice = 5;
              else 
                indice = 6;
            }
            else if(d==28){
              if(x=='1')
                indice = 0;
              else if(x=='2')
                indice = 1;
              else if(x=='3')
                indice = 2;
              else if(x=='4')
                indice = 3;
              else if(x=='5')
                indice = 4;
              else if(x=='6')
                indice = 5;
              else 
                indice = 6;
            }
            else{ 
              indice = dados.indexOf(x);
            }
            if (valores[indice] == null) {
                valores[indice] = 0;
              }
            valores[indice]++;
          }
        }

        //gera array no formato data:value para printar no grafico
        for(var i = 0; i<valores.length;i++){
          data.push({
            name: dados[i],
            y: valores[i]
          });
        }
        graphic();
      } 
      


      function graphic(){
        var escolhaGrafico = document.querySelectorAll('input[type=radio]:checked')[0].value;
        if (escolhaGrafico == "Pizza") {
          Highcharts.chart('container', {
              chart: {
                  type: 'pie',
                  options3d: {
                      enabled: true,
                      alpha: 45,
                      beta: 0
                  }
              },
              title: {
                  text: nomeSerie,            },
              tooltip: {
                  pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
              },
              plotOptions: {
                  pie: {
                      allowPointSelect: true,
                      cursor: 'pointer',
                      depth: 35,
                      dataLabels: {
                          enabled: true,
                          format: '{point.name}:{point.y}',
                      }
                  }
              },
              series: [{
                  type: 'pie',
                  name: 'Browser share',
                  data:  data
              }]
          });   

        }
        else if (escolhaGrafico == 'Coluna'){
          Highcharts.chart('container', {
              chart: {
                  type: 'column',
                  options3d: {
                      enabled: true,
                      alpha: 10,
                      beta: 25,
                      depth: 70
                  }
              },
              title: {
                  text: "",
              },
              subtitle: {
                  text: ''
              },
              plotOptions: {
                  column: {
                      depth: 25
                  }
              },
              xAxis: {
                  categories: dados,
                  labels: {
                      skew3d: true,
                      style: {
                          fontSize: '16px'
                      }
                  }
              },
              yAxis: {
                  title: {
                      text: null
                  }
              },
              series: [{
                  name: [nomeSerie],
                  data: valores
              }]
          });
        }
      };

    </script> 
  </body>
</html>